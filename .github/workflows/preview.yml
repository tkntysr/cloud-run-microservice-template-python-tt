name: Deploy Preview to Cloud Run


 # ã€èª²é¡Œ1ã€‘ãƒˆãƒªã‚¬ãƒ¼ã®è¨­å®š
      # PRãŒä½œã‚‰ã‚ŒãŸã¨ã,é–‰ã˜ã‚‰ã‚ŒãŸæ™‚ãªã©ã«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå‹•ãã‚ˆã†ã«ã€ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã‚’è¿½åŠ ã—ã¦ãã ã•ã„
     
on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - closed
     

env:
  # â€» æ¼”ç¿’ç’°å¢ƒã«åˆã‚ã›ã¦å€¤ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„
  PROJECT_ID: ex-ai-training-program
  GAR_LOCATION: asia-northeast1
  REPOSITORY: t-takano-20260213
  SERVICE_BASE: python-microservice
  REGION: asia-northeast1

jobs:
  # ===================================================
  # Job 1: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã®ãƒ‡ãƒ—ãƒ­ã‚¤ (Open/Updateæ™‚)
  # ===================================================
  deploy-preview:
    # PRãŒClosedã®æ™‚ã¯ã“ã®ã‚¸ãƒ§ãƒ–ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã‚‚è‰¯ã„
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
      pull-requests: 'write'

    steps:
      - name: Checkout
        uses: actions/checkout@v4




      # ã€èª²é¡Œ2ã€‘ã‚µãƒ¼ãƒ“ã‚¹åã®ç”Ÿæˆ
      # ä»¥ä¸‹ã®è¦ä»¶ã§ç’°å¢ƒå¤‰æ•° SERVICE_NAME ã‚’è¨­å®šã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„
      # - å½¢å¼: [ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹]-pr-[PRç•ªå·]
      # - ãƒ’ãƒ³ãƒˆ: PRç•ªå·ã¯ github.event.number ã§å–å¾—ã§ãã¾ã™
      # - ãƒ’ãƒ³ãƒˆ: GITHUB_ENV ã¸ã®æ›¸ãè¾¼ã¿ãŒå¿…è¦ã§ã™
      - name: Set Service Name
        run: echo "SERVICE_NAME=${{ env.SERVICE_BASE }}-pr-${{ github.event.number }}" >> $GITHUB_ENV

      # Google Cloud èªè¨¼
      - name: Google Auth
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ secrets.WIF_PROVIDER }}'
          project_id: '${{ env.PROJECT_ID }}'

      # gcloud ã‚³ãƒãƒ³ãƒ‰ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'
        with:
          project_id: '${{ env.PROJECT_ID }}'

      # ã€èª²é¡Œ3ã€‘Cloud Build ã§ã®ãƒ“ãƒ«ãƒ‰ & Push
      # Cloud Build ã‚’ä½¿ã£ã¦ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ“ãƒ«ãƒ‰ã—ã€Artifact Registry ã« Push ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„
      # - ã‚³ãƒãƒ³ãƒ‰: gcloud builds submit
      # - ã‚¿ã‚°: ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
      # - ãƒ“ãƒ«ãƒ‰ãƒ‘ã‚¹: ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª (.)
      - name: Build and Push via Cloud Build
        run: |-
          gcloud builds submit \
            --tag "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${{ github.sha }}" \
            --project "${{ env.PROJECT_ID }}" \
            .

      # ã€èª²é¡Œ4ã€‘Cloud Run ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
      # google-github-actions/deploy-cloudrun@v2 ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®è¨­å®šã‚’å®Œæˆã•ã›ã¦ãã ã•ã„
      # å¿…è¦ãªè¨­å®š: service, region, image, tag(PRç•ªå·), flags(--allow-unauthenticated)
      - name: Deploy to Cloud Run
        uses: 'google-github-actions/deploy-cloudrun@v2'
        with:
          service: '${{ env.SERVICE_NAME }}'
          region: '${{ env.REGION }}'
          image: '${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${{ github.sha }}'
          tag: '${{ github.event.number }}'
          flags: '--allow-unauthenticated'



      # ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†é€šçŸ¥ (ã“ã“ã¯ãã®ã¾ã¾åˆ©ç”¨)
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const url = '${{ steps.deploy.outputs.url }}';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸš€ **Preview Environment Deployed!**\n\nApp is running at: ${url}\n\n(Latest commit: ${context.sha})`
            })

  # ===================================================
  # Job 2: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã®å‰Šé™¤ (Close/Mergeæ™‚)
  # ===================================================
  cleanup-preview:
    # ã€èª²é¡Œ5ã€‘å®Ÿè¡Œæ¡ä»¶ã®è¨­å®š
    # PRãŒã€Œé–‰ã˜ã‚‰ã‚ŒãŸ (closed)ã€æ™‚ã®ã¿ã€ã“ã®ã‚¸ãƒ§ãƒ–ãŒå®Ÿè¡Œã•ã‚Œã‚‹æ¡ä»¶å¼ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„
    if: github.event.action == 'closed'
    
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
      pull-requests: 'write'

    steps:
      # Job 1ã¨åŒæ§˜ã«ã‚µãƒ¼ãƒ“ã‚¹åã‚’å®šç¾© (ã“ã“ã¯è¨˜å…¥æ¸ˆã¿)
      - name: Set Service Name
        run: echo "SERVICE_NAME=${{ env.SERVICE_BASE }}-pr-${{ github.event.number }}" >> $GITHUB_ENV

      - name: Google Auth
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ secrets.WIF_PROVIDER }}'

      - name: Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'

      # ã€èª²é¡Œ6ã€‘Cloud Run ã‚µãƒ¼ãƒ“ã‚¹ã®å‰Šé™¤
      # ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã‚’å‰Šé™¤ã™ã‚‹ gcloud ã‚³ãƒãƒ³ãƒ‰ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„
      # - ã‚³ãƒãƒ³ãƒ‰: gcloud run services delete
      # - å¯¾è±¡: ç’°å¢ƒå¤‰æ•° SERVICE_NAME
      # - ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: ç’°å¢ƒå¤‰æ•° REGION
      # - ç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ãƒ•ãƒ©ã‚° (--quiet) ã‚’å¿…ãšã¤ã‘ã‚‹ã“ã¨
      - name: Delete Cloud Run Service
        run: |
          echo "Deleting service: ${{ env.SERVICE_NAME }}"
          gcloud run services delete ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --quiet

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ—‘ï¸ **Preview Environment Deleted.**\n\nThe Cloud Run service has been cleaned up.`
            })


      # WIFèªè¨¼
      - name: Google Auth
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ secrets.WIF_PROVIDER }}'

      # ã€èª²é¡Œ5ã€‘å‰Šé™¤ã‚³ãƒãƒ³ãƒ‰ã®è¨˜è¿°
      # - ã‚³ãƒãƒ³ãƒ‰: gcloud run services delete
      # - å¯¾è±¡: ç’°å¢ƒå¤‰æ•° SERVICE_NAME
      # - ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: ç’°å¢ƒå¤‰æ•° REGION
      # - ç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: ã‚¹ã‚­ãƒƒãƒ— (--quiet)
      - name: Delete Cloud Run Service
        run: |
          echo "Deleting service: ${{ env.SERVICE_NAME }}"
          gcloud run services delete ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --quiet

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ—‘ï¸ **Preview Environment Deleted.**\n\nThe Cloud Run service has been cleaned up.`
            })